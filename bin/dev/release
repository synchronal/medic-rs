#!/usr/bin/env bash

trap "exit" INT

source ".medic/_support/cecho.sh"
source ".medic/_support/step.sh"

set -e

mkdir -p tmp/release
mkdir -p target/universal-apple-darwin/release

step_header "Build: Darwin aarch64" "cargo build --target aarch64-apple-darwin --workspace -r"
echo
cargo build --target aarch64-apple-darwin --workspace -r

step_header "Build: Darwin x86_64" "cargo build --target x86_64-apple-darwin --workspace -r"
echo
cargo build --target x86_64-apple-darwin --workspace -r


medic=(medic medic-audit medic-doctor medic-shipit medic-test medic-update \
           medic-check-asdf medic-check-homebrew medic-step-git medic-step-github)
medic_elixir=(medic-check-elixir medic-step-elixir)
medic_node=(medic-check-npm)
medic_rust=(medic-check-rust medic-step-rust)

cmds=(${medic[@]})
cmds+=(${medic_elixir[@]})
cmds+=(${medic_node[@]})
cmds+=(${medic_rust[@]})

for cmd in ${cmds[@]}; do
  step "${cmd}: darwin universal" \
    "(cd target/universal-apple-darwin/release \
      && lipo ../../aarch64-apple-darwin/release/${cmd} ../../x86_64-apple-darwin/release/${cmd} -create -output ${cmd})"
done

step "medic: Create tar file" \
  "(cd target/universal-apple-darwin/release \
    && tar -czf ../../../tmp/release/medic-darwin-universal.tar.gz ${medic[*]})"

step "medic-elixir: Create tar file" \
  "(cd target/universal-apple-darwin/release \
    && tar -czf ../../../tmp/release/medic-elixir-darwin-universal.tar.gz ${medic_elixir[*]})"

step "medic-node: Create tar file" \
  "(cd target/universal-apple-darwin/release \
    && tar -czf ../../../tmp/release/medic-node-darwin-universal.tar.gz ${medic_node[*]})"

step "medic-rust: Create tar file" \
  "(cd target/universal-apple-darwin/release \
    && tar -czf ../../../tmp/release/medic-rust-darwin-universal.tar.gz ${medic_rust[*]})"

pushd tmp/release >/dev/null

for file in $(ls *.tar.gz); do

step "shasum: Darwin aarch64" \
  "(sha256sum ${file} > ${file}.sha256sum)"

done

popd >/dev/null

cecho --bright-green "\nChecksums:"
(cd tmp/release && cat *.sha256sum)

